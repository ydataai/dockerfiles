name: Prereleased

on:
  release:
    types: [ prereleased ]

env:
  COMPONENT: laboratory-controller/base

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-20.04

    outputs:
      version: ${{ steps.version.outputs.value }}

    steps:
    - name: Version
      id: version
      run: echo ::set-output name=value::`echo ${{ github.ref }} | sed -n -E 's/refs\/tags\/([0-9]+.[0-9]+.[0-9]+)/\1/p'`

  base-python-images-cpu:
    name: Laboratories Base Python CPU
    runs-on: ubuntu-20.04

    needs: prepare

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Lab Base Python images
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=python TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  base-python-images-gpu:
    name: Laboratories Base Python GPU
    runs-on: ubuntu-20.04

    needs: prepare

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python images CUDA 10.0
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=python TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

    - name: Lab Base Python images CUDA 10.1
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=python TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

    - name: Lab Base Python images CUDA 11
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=python TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=11.0

  base-r-images-cpu:
    name: Laboratories Base R CPU
    runs-on: ubuntu-20.04

    needs: prepare

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Lab Base R images
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=r TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  base-r-images-gpu:
    name: Laboratories Base R GPU
    runs-on: ubuntu-20.04

    needs: prepare

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Lab Base R images CUDA 10.0
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=r TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

    - name: Lab Base R images CUDA 10.1
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=r TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

    - name: Lab Base R images CUDA 11.0
      run: make all IMAGE=data-science/laboratories-base LANGUAGE=r TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=11.0

  jupyterlab-python-images-cpu:
    name: JupyterLab Python CPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-python-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/jupyterlab_python/requirements-ydata.txt

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python images
      run: make all IMAGE=data-science/jupyterlab_python TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-python-images-gpu:
    name: JupyterLab Python GPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-python-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/jupyterlab_python/requirements-ydata.txt

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python images CUDA 10.0
      run: make all IMAGE=data-science/jupyterlab_python TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

    - name: JupyterLab Python images CUDA 10.1
      run: make all IMAGE=data-science/jupyterlab_python TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

    - name: JupyterLab Python images CUDA 11.0
      run: make all IMAGE=data-science/jupyterlab_python TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=11.0

  jupyterlab-python-tensorflow-115-images-cpu:
    name: JupyterLab Python Tensorflow 1.15 CPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python Tensorflow 1.15 Bundles images
      run: make all IMAGE=data-science/jupyterlab_python_tensorflow-1.15 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-python-tensorflow-115-images-gpu:
    name: JupyterLab Python Tensorflow 1.15 GPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python Tensorflow 1.15 Bundles images
      run: make all IMAGE=data-science/jupyterlab_python_tensorflow-1.15 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

  jupyterlab-python-tensorflow-23-images-cpu:
    name: JupyterLab Python Tensorflow 2.3 CPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python Tensorflow 2.3 Bundles images
      run: make all IMAGE=data-science/jupyterlab_python_tensorflow-2.3 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-python-tensorflow-23-images-gpu:
    name: JupyterLab Python Tensorflow 2.3 GPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python Tensorflow 2.3 Bundles images
      run: make all IMAGE=data-science/jupyterlab_python_tensorflow-2.3 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  jupyterlab-python-torch-images-cpu:
    name: JupyterLab Python Torch CPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python Torch images
      run: make all IMAGE=data-science/jupyterlab_python_torch-1.7 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-python-torch-images-gpu:
    name: JupyterLab Python Torch GPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab Python Torch images
      run: make all IMAGE=data-science/jupyterlab_python_torch-1.7 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  jupyterlab-python-ydata-image-cpu:
    name: YData CPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/github.com/https:\/\/${{ secrets.ACCESS_TOKEN }}:x-oauth-basic@github.com/g' data-science/ydata/requirements.txt
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/ydata/requirements.txt

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.PRIVATE_CONTAINER_REGISTRY }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: YData image
      run: make all IMAGE=data-science/ydata TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-python-ydata-image-gpu:
    name: YData GPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-python-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/github.com/https:\/\/${{ secrets.ACCESS_TOKEN }}:x-oauth-basic@github.com/g' data-science/ydata/requirements.txt
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/ydata/requirements.txt

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.PRIVATE_CONTAINER_REGISTRY }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: YData image
      run: make all IMAGE=data-science/ydata TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=11.0

  jupyterlab-r-images-cpu:
    name: JupyterLab R CPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-r-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R images
      run: make all IMAGE=data-science/jupyterlab_r TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-r-images-gpu:
    name: JupyterLab R GPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-r-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R images CUDA 10.0
      run: make all IMAGE=data-science/jupyterlab_r TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

    - name: JupyterLab R images CUDA 10.1
      run: make all IMAGE=data-science/jupyterlab_r TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  jupyterlab-r-tensorflow-115-images-cpu:
    name: JupyterLab R Tensorflow 1.15 CPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-r-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R Tensorflow images
      run: make all IMAGE=data-science/jupyterlab_r_tensorflow-1.15 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-r-tensorflow-115-images-gpu:
    name: JupyterLab R Tensorflow 1.15 GPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-r-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R Tensorflow images
      run: make all IMAGE=data-science/jupyterlab_r_tensorflow-1.15 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

  jupyterlab-r-tensorflow-23-images-cpu:
    name: JupyterLab R Tensorflow CPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-r-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R Tensorflow images
      run: make all IMAGE=data-science/jupyterlab_r_tensorflow-2.3 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-r-tensorflow-23-images-gpu:
    name: JupyterLab R Tensorflow GPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-r-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R Tensorflow images
      run: make all IMAGE=data-science/jupyterlab_r_tensorflow-1.15 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  jupyterlab-r-torch-images-cpu:
    name: JupyterLab R Torch CPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-r-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R Torch images
      run: make all IMAGE=data-science/jupyterlab_r_torch TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  jupyterlab-r-torch-images-gpu:
    name: JupyterLab R Torch GPU
    runs-on: ubuntu-20.04

    needs: [prepare, jupyterlab-r-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: JupyterLab R Torch images
      run: make all IMAGE=data-science/jupyterlab_r_torch TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  h2o-images-cpu:
    name: H2O CPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-python-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: H2O images
      run: make all IMAGE=data-science/h2oflow TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  h2o-images-gpu:
    name: H2O GPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-python-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: H2O images
      run: make all IMAGE=data-science/h2oflow TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

  rstudio-images-cpu:
    name: RStudio CPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-r-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio images
      run: make all IMAGE=data-science/rstudio TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  rstudio-images-gpu:
    name: RStudio GPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-r-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio images
      run: make all IMAGE=data-science/rstudio TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

  rstudio-tensorflow-115-images-cpu:
    name: RStudio Tensorflow 1.15 CPU
    runs-on: ubuntu-20.04

    needs: [prepare, rstudio-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio Tensorflow images
      run: make all IMAGE=data-science/rstudio_tensorflow-1.15 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  rstudio-tensorflow-23-images-cpu:
    name: RStudio Tensorflow 2.3 CPU
    runs-on: ubuntu-20.04

    needs: [prepare, rstudio-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio Tensorflow images
      run: make all IMAGE=data-science/rstudio_tensorflow-2.3 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  rstudio-tensorflow-115-images-gpu:
    name: RStudio Tensorflow 1.15 GPU
    runs-on: ubuntu-20.04

    needs: [prepare, rstudio-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio Tensorflow images
      run: make all IMAGE=data-science/rstudio_tensorflow-1.15 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

  rstudio-tensorflow-23-images-gpu:
    name: RStudio Tensorflow 2.3 GPU
    runs-on: ubuntu-20.04

    needs: [prepare, rstudio-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio Tensorflow images
      run: make all IMAGE=data-science/rstudio_tensorflow-2.3 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  rstudio-torch-images-cpu:
    name: RStudio Torch CPU
    runs-on: ubuntu-20.04

    needs: [prepare, rstudio-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio Torch images
      run: make all IMAGE=data-science/rstudio_torch TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  rstudio-torch-images-gpu:
    name: RStudio Torch GPU
    runs-on: ubuntu-20.04

    needs: [prepare, rstudio-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: RStudio Torch images
      run: make all IMAGE=data-science/rstudio_torch TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

  visualcode-images-cpu:
    name: Visual Code CPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-python-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/visualcode/requirements-ydata.txt

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code images
      run: make all IMAGE=data-science/visualcode TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  visualcode-images-gpu:
    name: Visual Code GPU
    runs-on: ubuntu-20.04

    needs: [prepare, base-python-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/visualcode/requirements-ydata.txt

    - name: Login to Docker Hub
      uses:  docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code images CUDA 10.0
      run: make all IMAGE=data-science/visualcode TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

    - name: Visual Code images CUDA 10.1
      run: make all IMAGE=data-science/visualcode TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

    - name: Visual Code images CUDA 11.0
      run: make all IMAGE=data-science/visualcode TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=11.0

  visualcode-tensorflow-115-images-cpu:
    name: Visual Code Tensorflow 1.15 CPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code Tensorflow 1.15 Bundles images
      run: make all IMAGE=data-science/visualcode_tensorflow-1.15 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  visualcode-tensorflow-115-images-gpu:
    name: Visual Code Tensorflow 1.15 GPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code Tensorflow 1.15 Bundles images
      run: make all IMAGE=data-science/visualcode_tensorflow-1.15 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.0

  visualcode-tensorflow-23-images-cpu:
    name: Visual Code Tensorflow 2.3 CPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code Tensorflow 2.3 Bundles images
      run: make all IMAGE=data-science/visualcode_tensorflow-2.3 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  visualcode-tensorflow-23-images-gpu:
    name: Visual Code Tensorflow 2.3 GPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code Tensorflow 2.3 Bundles images
      run: make all IMAGE=data-science/visualcode_tensorflow-2.3 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  visualcode-torch-images-cpu:
    name: Visual Code Torch CPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code Torch Bundles images
      run: make all IMAGE=data-science/visualcode_torch-1.7 TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  visualcode-torch-images-gpu:
    name: Visual Code Torch GPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Visual Code Torch Bundles images
      run: make all IMAGE=data-science/visualcode_torch-1.7 TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=10.1

  visualcode-ydata-image-cpu:
    name: VisualCode YData CPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-cpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/github.com/https:\/\/${{ secrets.ACCESS_TOKEN }}:x-oauth-basic@github.com/g' data-science/visualcode_ydata/requirements.txt
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/visualcode_ydata/requirements.txt

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.PRIVATE_CONTAINER_REGISTRY }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: VisualCode YData image
      run: make all IMAGE=data-science/visualcode_ydata TYPE=cpu TAG=${{ needs.prepare.outputs.version }}

  visualcode-ydata-image-gpu:
    name: VisualCode YData GPU
    runs-on: ubuntu-20.04

    needs: [prepare, visualcode-images-gpu]

    steps:
    - uses: actions/checkout@v2

    - name: Add authentication to requirements file
      run: |
        sed -i 's/https:\/\/github.com/https:\/\/${{ secrets.ACCESS_TOKEN }}:x-oauth-basic@github.com/g' data-science/visualcode_ydata/requirements.txt
        sed -i 's/https:\/\/pypi.ydata.ai/https:\/\/${{ secrets.PRIVATE_PYPI_USERNAME }}:${{ secrets.PRIVATE_PYPI_PASSWORD }}@pypi.ydata.ai/g' data-science/visualcode_ydata/requirements.txt

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.PRIVATE_CONTAINER_REGISTRY }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: VisualCode YData image
      run: make all IMAGE=data-science/visualcode_ydata TYPE=gpu TAG=${{ needs.prepare.outputs.version }} CUDA=11.0


  update-manifests:
    name: Update Manifests
    runs-on: ubuntu-20.04

    needs: [prepare,
            jupyterlab-python-tensorflow-115-images-cpu,
            jupyterlab-python-tensorflow-115-images-gpu,
            jupyterlab-python-tensorflow-23-images-cpu,
            jupyterlab-python-tensorflow-23-images-gpu,
            jupyterlab-python-torch-images-cpu,
            jupyterlab-python-torch-images-gpu,
            jupyterlab-python-ydata-image-cpu,
            jupyterlab-python-ydata-image-gpu,
            jupyterlab-r-tensorflow-115-images-cpu,
            jupyterlab-r-tensorflow-115-images-gpu,
            jupyterlab-r-tensorflow-23-images-cpu,
            jupyterlab-r-tensorflow-23-images-gpu,
            jupyterlab-r-torch-images-cpu,
            jupyterlab-r-torch-images-gpu,
            h2o-images-cpu,
            h2o-images-gpu,
            rstudio-tensorflow-images-cpu,
            rstudio-tensorflow-115-images-gpu,
            rstudio-tensorflow-23-images-gpu,
            rstudio-torch-images-cpu,
            rstudio-torch-images-gpu,
            visualcode-tensorflow-115-images-cpu,
            visualcode-tensorflow-115-images-gpu,
            visualcode-tensorflow-23-images-gpu,
            visualcode-tensorflow-23-images-cpu,
            visualcode-torch-images-cpu,
            visualcode-torch-images-gpu,
            visualcode-ydata-image-cpu,
            visualcode-ydata-image-gpu]

    steps:
    - name: Mount laboratories images tag version
      env:
        VERSION: ${{ needs.prepare.outputs.version }}
      id: replace
      uses: frabert/replace-string-action@v1.2
      with:
        pattern: VERSION
        flags: g
        string: 'rstudio-cpu:VERSION,rstudio-gpu:VERSION,jupyterlab_r-cpu:VERSION,jupyterlab_python-cpu:VERSION,jupyterlab_r-gpu:VERSION,jupyterlab_python-gpu:VERSION,ydata-cpu:VERSION,ydata-gpu:VERSION,h2oflow-cpu:VERSION,h2oflow-gpu:VERSION,tensorflow-1.15-cpu:VERSION,tensorflow-1.15-gpu:VERSION,tensorflow-2.3-cpu:VERSION,tensorflow-2.3-gpu:VERSION,torch-1.7-cpu:VERSION,torch-1.7-gpu:VERSION,visualcode-cpu:VERSION,visualcode-gpu:VERSION'
        replace-with: ${{ env.VERSION }}

    - name: Checkout Manifests repo
      uses: actions/checkout@v2
      with:
        repository: ydataai/manifests
        token: ${{ secrets.ACCESS_TOKEN }}

    - name: Update params.env with laboratories image tag
      run: |
        cd ydata/${COMPONENT}
        sed -i -r 's/\laboratoriesImageTag=(.*)/laboratoriesImageTag=${{steps.replace.outputs.replaced}}/g' params.env

    - name: Commit and push image update into manifests repo
      env:
        VERSION: ${{ needs.prepare.outputs.version }}
      run: |
        git config user.email "azory@ydata.ai"
        git config user.name "Azory YData Bot"
        git commit -a -m "chore(bump): [CI] [DEV] bump laboratories image tag to $VERSION"
        git push origin master
